<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin UTP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header"><span>ADMIN</span></div>
        <ul class="sidebar-menu">
            <li><a onclick="ver('alumnos')" id="link-alumnos" class="active"><i class="fa fa-users"></i><span>Alumnos</span></a></li>
            <li><a onclick="ver('profesores')" id="link-profesores"><i class="fa fa-chalkboard-user"></i><span>Profesores</span></a></li>
            <li><a onclick="ver('cursos')" id="link-cursos"><i class="fa fa-book"></i><span>Cursos</span></a></li>
            <li><a onclick="ver('asignacion')" id="link-asignacion"><i class="fa fa-calendar-check"></i><span>Horarios</span></a></li>
            <li style="margin-top:50px"><a href="index.html" class="text-danger"><i class="fa fa-power-off"></i><span>Salir</span></a></li>
        </ul>
    </nav>

    <main class="main-content">
        
        <section id="view-alumnos" class="section-view active">
            <h2 class="mb-4 fw-bold">Gesti√≥n de Alumnos</h2>
            <div class="card-custom mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="fw-bold">Filtrar por Carrera</label>
                        <select id="filtroCarreraAlu" class="form-select" onchange="cargarAlumnos()"></select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-black w-100" onclick="cargarAlumnos()">Filtrar</button>
                    </div>
                </div>
            </div>
            <table class="table table-hover border-black bg-white">
                <thead class="table-dark"><tr><th>Nombre</th><th>Correo</th><th>Ciclo</th><th>Carrera</th></tr></thead>
                <tbody id="tabla-alumnos"><tr><td colspan="4" class="text-center">Seleccione una carrera...</td></tr></tbody>
            </table>
        </section>

        <section id="view-profesores" class="section-view">
            <h2 class="mb-4 fw-bold">Gesti√≥n de Profesores</h2>
            <div class="card-custom mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="fw-bold">Filtrar por Carrera</label>
                        <select id="filtroCarreraProf" class="form-select" onchange="cargarProfesores()"></select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-black w-100" onclick="cargarProfesores()">Filtrar</button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNuevoProfe">
                            <i class="fa fa-plus"></i> Nuevo Profesor
                        </button>
                    </div>
                </div>
            </div>
            <table class="table table-hover border-black bg-white">
                <thead class="table-dark"><tr><th>Nombre</th><th>Correo</th><th>Carrera</th></tr></thead>
                <tbody id="tabla-profesores"><tr><td colspan="3" class="text-center">Seleccione una carrera para ver los datos.</td></tr></tbody>
            </table>
        </section>

        <section id="view-cursos" class="section-view">
            <h2 class="mb-4 fw-bold">Gesti√≥n de Cursos</h2>
            <div class="card-custom mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="fw-bold">Filtrar por Carrera</label>
                        <select id="filtroCarreraCur" class="form-select" onchange="cargarCursosAdmin()"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold">Filtrar por Ciclo</label>
                        <select id="filtroCicloCur" class="form-select" onchange="cargarCursosAdmin()">
                            <option value="0">Todos</option>
                            <option value="1">Ciclo 1</option><option value="2">Ciclo 2</option><option value="3">Ciclo 3</option>
                            <option value="4">Ciclo 4</option><option value="5">Ciclo 5</option><option value="6">Ciclo 6</option>
                            <option value="7">Ciclo 7</option><option value="8">Ciclo 8</option><option value="9">Ciclo 9</option>
                            <option value="10">Ciclo 10</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-black w-100" onclick="cargarCursosAdmin()">Filtrar</button>
                    </div>
                </div>
            </div>
            <table class="table table-hover border-black bg-white">
                <thead class="table-dark"><tr><th>C√≥digo</th><th>Nombre</th><th>Ciclo</th><th>Cr√©ditos</th></tr></thead>
                <tbody id="tabla-cursos"><tr><td colspan="4" class="text-center">Seleccione filtros...</td></tr></tbody>
            </table>
        </section>

        <section id="view-asignacion" class="section-view">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Gesti√≥n de Horarios</h2>
                <button class="btn btn-black btn-lg" onclick="abrirModalHorario()">
                    <i class="fa fa-plus-circle"></i> Asignar Nuevo Horario
                </button>
            </div>

            <div class="card-custom mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="fw-bold">Filtrar por Carrera</label>
                        <select id="filtroCarreraHor" class="form-select" onchange="cargarTablaHorarios()"></select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-black w-100" onclick="cargarTablaHorarios()">Filtrar</button>
                    </div>
                </div>
            </div>

            <div class="card-custom">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered border-black align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Ciclo</th>
                                <th>Curso</th>
                                <th>Secci√≥n</th>
                                <th>Docente</th>
                                <th>D√≠as</th>
                                <th>Horario</th>
                                <th>Vac</th>
                                <th>Mod</th>
                                <th style="width: 100px;">Acciones</th> </tr>
                        </thead>
                        <tbody id="tabla-horarios-todos">
                            <tr><td colspan="9" class="text-center">Seleccione carrera...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <div class="modal fade" id="modalNuevoProfe" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content rounded-0 border-2 border-black">
                <div class="modal-header bg-black text-white rounded-0">
                    <h5 class="modal-title">Registrar Profesor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label>Nombre</label><input id="profNom" class="form-control"></div>
                    <div class="mb-2"><label>Correo</label><input id="profEmail" class="form-control"></div>
                    <div class="mb-2"><label>Contrase√±a</label><input id="profPass" type="password" class="form-control"></div>
                    <div class="mb-3"><label>Carrera</label><select id="profCarreraSelect" class="form-select"></select></div>
                    <button onclick="crearProfesor()" class="btn btn-success w-100">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAsignacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content rounded-0 border-2 border-black">
                <div class="modal-header bg-black text-white rounded-0">
                    <h5 class="modal-title" id="modalTitleHorario">Asignar Horario a Curso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="idHorarioEditar"> 
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="fw-bold">1. Seleccionar Carrera</label>
                            <select id="asigCarrera" class="form-select" onchange="cargarDatosAsignacion()"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold">2. Seleccionar Curso</label>
                            <select id="asigCurso" class="form-select" disabled><option>Esperando carrera...</option></select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="fw-bold">3. Seleccionar Profesor</label>
                            <select id="asigProf" class="form-select" disabled><option>Esperando carrera...</option></select>
                        </div>
                        
                        <div class="col-md-3">
                            <label>Secci√≥n</label>
                            <input id="asigSec" class="form-control" placeholder="Ej: 10599">
                        </div>
                        <div class="col-md-3">
                            <label>Vacantes</label>
                            <input id="asigVac" type="number" class="form-control" value="30">
                        </div>

                        <div class="col-12"><hr></div>

                        <div class="col-md-12">
                            <label class="fw-bold d-block mb-2">D√≠as de Clase (Seleccione uno o varios)</label>
                            <div class="d-flex gap-3 flex-wrap p-2 border rounded">
                                <div class="form-check"><input class="form-check-input chk-dia" type="checkbox" value="Lunes" id="d1"><label class="form-check-label" for="d1">Lunes</label></div>
                                <div class="form-check"><input class="form-check-input chk-dia" type="checkbox" value="Martes" id="d2"><label class="form-check-label" for="d2">Martes</label></div>
                                <div class="form-check"><input class="form-check-input chk-dia" type="checkbox" value="Miercoles" id="d3"><label class="form-check-label" for="d3">Mi√©rcoles</label></div>
                                <div class="form-check"><input class="form-check-input chk-dia" type="checkbox" value="Jueves" id="d4"><label class="form-check-label" for="d4">Jueves</label></div>
                                <div class="form-check"><input class="form-check-input chk-dia" type="checkbox" value="Viernes" id="d5"><label class="form-check-label" for="d5">Viernes</label></div>
                                <div class="form-check"><input class="form-check-input chk-dia" type="checkbox" value="Sabado" id="d6"><label class="form-check-label" for="d6">S√°bado</label></div>
                            </div>
                        </div>

                        <div class="col-md-3"><label>Inicio</label><input type="time" id="asigIni" class="form-control"></div>
                        <div class="col-md-3"><label>Fin</label><input type="time" id="asigFin" class="form-control"></div>
                        <div class="col-md-3">
                            <label>Modalidad</label>
                            <select id="asigMod" class="form-select">
                                <option value="Presencial">Presencial</option>
                                <option value="Virtual">Virtual</option>
                                <option value="H√≠brido">24/7</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end"><button onclick="guardarHorario()" class="btn btn-black w-100">GUARDAR</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfirm" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content rounded-0 border-2 border-black">
                <div class="modal-header bg-black text-white rounded-0">
                    <h5 class="modal-title">Confirmaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <i class="fa fa-exclamation-circle fa-4x text-danger mb-3"></i>
                    <p class="fs-5 fw-bold" id="msgConfirm">¬øEst√° seguro?</p>
                    <p class="text-muted small">Esta acci√≥n no se puede deshacer.</p>
                    
                    <div class="mt-4 d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-secondary rounded-0 px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" id="btnConfirmYes" class="btn btn-danger rounded-0 px-4">S√≠, Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_AUTH = 'http://localhost:3001/api'; 
        const API_CUR = 'http://localhost:3002/api'; 
        const API_HOR = 'http://localhost:3003/api';

        const modalProf = new bootstrap.Modal(document.getElementById('modalNuevoProfe'));
        const modalAsig = new bootstrap.Modal(document.getElementById('modalAsignacion'));
        const modalConfirm = new bootstrap.Modal(document.getElementById('modalConfirm')); // Nuevo Modal

        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl);

        let idEliminarTemp = null; // Variable para almacenar ID a eliminar

        // --- TOAST FUNCTION ---
        function mostrarToast(msg, bgClass = 'bg-primary') {
            document.getElementById('toast-message').innerText = msg;
            toastEl.className = `toast align-items-center text-white border-0 ${bgClass}`;
            toast.show();
        }

        document.addEventListener('DOMContentLoaded', async () => { 
            await cargarCarreras(); 
            ver('alumnos'); 
        });

        function ver(id) {
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.getElementById('link-'+id).classList.add('active');
            document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            
            if(id === 'profesores') cargarProfesores();
            if(id === 'cursos') cargarCursosAdmin();
            if(id === 'asignacion') cargarTablaHorarios();
        }

        async function cargarCarreras() {
            const res = await fetch(API_AUTH + '/carreras'); const data = await res.json();
            const fill = (id) => { const s = document.getElementById(id); s.innerHTML='<option value="0">Seleccione...</option>'; data.forEach(c=>s.innerHTML+=`<option value="${c.id}">${c.nombre}</option>`); };
            fill('filtroCarreraAlu'); fill('filtroCarreraProf'); fill('filtroCarreraCur'); fill('asigCarrera'); fill('profCarreraSelect'); fill('filtroCarreraHor');
        }

        // --- ALUMNOS Y PROFESORES ---
        async function cargarAlumnos() {
            const cid = document.getElementById('filtroCarreraAlu').value; const tb = document.getElementById('tabla-alumnos'); tb.innerHTML='';
            if(cid==0) { tb.innerHTML='<tr><td colspan="4" class="text-center">Seleccione carrera</td></tr>'; return; }
            const res = await fetch(`${API_AUTH}/usuarios?rol=alumno&carrera=${cid}`); const data = await res.json();
            if(data.length===0) tb.innerHTML='<tr><td colspan="4" class="text-center">Sin alumnos</td></tr>';
            data.forEach(u => tb.innerHTML+=`<tr><td>${u.nombre}</td><td>${u.correo}</td><td>${u.ciclo}</td><td>${u.carrera||'-'}</td></tr>`);
        }
        async function cargarProfesores() {
            const cid = document.getElementById('filtroCarreraProf').value; const tb = document.getElementById('tabla-profesores'); tb.innerHTML='';
            if(cid==0) { tb.innerHTML='<tr><td colspan="3" class="text-center">Seleccione carrera</td></tr>'; return; }
            const res = await fetch(`${API_AUTH}/usuarios?rol=profesor&carrera=${cid}`); const data = await res.json();
            if(data.length===0) tb.innerHTML='<tr><td colspan="3" class="text-center">Sin profesores</td></tr>';
            data.forEach(u => tb.innerHTML+=`<tr><td>${u.nombre}</td><td>${u.correo}</td><td>${u.carrera||'General'}</td></tr>`);
        }
        async function crearProfesor() {
            const b = { nombre: document.getElementById('profNom').value, correo: document.getElementById('profEmail').value, contrasena: document.getElementById('profPass').value, carrera_id: document.getElementById('profCarreraSelect').value, rol: 'profesor' };
            const res = await fetch(API_AUTH+'/usuarios', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(b)});
            if(res.ok) { mostrarToast('‚úÖ Profesor creado', 'bg-success'); modalProf.hide(); cargarProfesores(); }
            else { mostrarToast('‚õî Error al crear', 'bg-danger'); }
        }

        // --- CURSOS ---
        async function cargarCursosAdmin() {
            const cid = document.getElementById('filtroCarreraCur').value; const ciclo = document.getElementById('filtroCicloCur').value; const tb = document.getElementById('tabla-cursos'); tb.innerHTML='';
            if(cid==0) { tb.innerHTML='<tr><td colspan="4" class="text-center">Seleccione carrera</td></tr>'; return; }
            const res = await fetch(`${API_CUR}/cursos?carrera=${cid}&ciclo=${ciclo}`); const data = await res.json();
            if(data.length===0) tb.innerHTML='<tr><td colspan="4" class="text-center">Sin cursos</td></tr>';
            data.forEach(c => tb.innerHTML+=`<tr><td>${c.codigo}</td><td>${c.nombre}</td><td>${c.ciclo}</td><td>${c.creditos}</td></tr>`);
        }

        // --- ASIGNACI√ìN Y HORARIOS ---
        function abrirModalHorario() {
            document.getElementById('idHorarioEditar').value = ''; 
            document.getElementById('modalTitleHorario').innerText = "Asignar Nuevo Horario";
            
            document.getElementById('asigCarrera').value = 0;
            document.getElementById('asigCurso').innerHTML = '<option>Esperando...</option>'; document.getElementById('asigCurso').disabled = true;
            document.getElementById('asigProf').innerHTML = '<option>Esperando...</option>'; document.getElementById('asigProf').disabled = true;
            document.getElementById('asigSec').value = '';
            document.getElementById('asigVac').value = 30;
            document.getElementById('asigIni').value = '';
            document.getElementById('asigFin').value = '';
            document.querySelectorAll('.chk-dia').forEach(cb => cb.checked = false);
            
            modalAsig.show();
        }

        async function editarHorario(hString) {
            const h = JSON.parse(decodeURIComponent(hString));
            document.getElementById('idHorarioEditar').value = h.id;
            document.getElementById('modalTitleHorario').innerText = "Editar Horario";
            
            document.getElementById('asigSec').value = h.seccion;
            document.getElementById('asigVac').value = h.vacantes;
            document.getElementById('asigIni').value = h.hora_inicio;
            document.getElementById('asigFin').value = h.hora_fin;
            document.getElementById('asigMod').value = h.modalidad || 'Presencial';
            
            const dias = h.dia.split(',').map(d=>d.trim());
            document.querySelectorAll('.chk-dia').forEach(cb => cb.checked = dias.includes(cb.value));

            const sc = document.getElementById('asigCurso'); sc.innerHTML = `<option value="${h.curso_id}" selected>${h.curso_nombre}</option>`; sc.disabled = false;
            const sp = document.getElementById('asigProf'); sp.innerHTML = `<option value="${h.profesor_id}" selected>${h.profesor_nombre}</option>`; sp.disabled = false;
            
            mostrarToast("‚ö†Ô∏è Modo edici√≥n: Verifica los datos.", "bg-info");
            modalAsig.show();
        }

        // --- L√ìGICA DE ELIMINACI√ìN CON MODAL ---
        function eliminarHorario(id) {
            idEliminarTemp = id;
            document.getElementById('msgConfirm').innerText = "¬øSeguro que desea eliminar este horario?";
            modalConfirm.show();
        }

        // Listener del bot√≥n "S√ç" del modal
        document.getElementById('btnConfirmYes').addEventListener('click', async () => {
            modalConfirm.hide();
            if(!idEliminarTemp) return;

            const res = await fetch(API_HOR+'/eliminar-horario', {
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({id: idEliminarTemp})
            });

            if(res.ok) { 
                mostrarToast("üóëÔ∏è Eliminado", "bg-warning"); 
                cargarTablaHorarios(); 
            } else { 
                mostrarToast("Error al eliminar", "bg-danger"); 
            }
            idEliminarTemp = null; // Reset
        });
        // ----------------------------------------

        async function cargarDatosAsignacion() {
            const cid = document.getElementById('asigCarrera').value;
            const sc = document.getElementById('asigCurso'); const sp = document.getElementById('asigProf');
            sc.innerHTML='<option>Cargando...</option>'; sp.innerHTML='<option>Cargando...</option>'; sc.disabled=true; sp.disabled=true;
            if(cid==0) { sc.innerHTML='<option>Esperando...</option>'; sp.innerHTML='<option>Esperando...</option>'; return; }
            
            const r1 = await fetch(`${API_CUR}/cursos?carrera=${cid}`); const d1 = await r1.json();
            sc.innerHTML=''; 
            if(d1.length==0) sc.innerHTML='<option>No hay cursos</option>';
            else d1.forEach(c => sc.innerHTML+=`<option value="${c.id}">${c.nombre} (Ciclo ${c.ciclo})</option>`); sc.disabled=false;

            const r2 = await fetch(`${API_AUTH}/usuarios?rol=profesor&carrera=${cid}`); const d2 = await r2.json();
            sp.innerHTML=''; 
            if(d2.length==0) sp.innerHTML='<option>No hay profesores</option>';
            else d2.forEach(p => sp.innerHTML+=`<option value="${p.id}">${p.nombre}</option>`); sp.disabled=false;
        }

        async function guardarHorario() {
            const dias = []; document.querySelectorAll('.chk-dia:checked').forEach(cb => dias.push(cb.value));
            if(dias.length===0) return mostrarToast("‚ö†Ô∏è Selecciona al menos un d√≠a", "bg-warning");

            const idEdit = document.getElementById('idHorarioEditar').value;
            const method = idEdit ? 'PUT' : 'POST'; 

            const data = {
                id: idEdit,
                curso_id: document.getElementById('asigCurso').value,
                seccion: document.getElementById('asigSec').value,
                profesor_id: document.getElementById('asigProf').value,
                profesor_nombre: document.getElementById('asigProf').options[document.getElementById('asigProf').selectedIndex].text,
                dia: dias.join(', '),
                inicio: document.getElementById('asigIni').value,
                fin: document.getElementById('asigFin').value,
                vacantes: document.getElementById('asigVac').value,
                modalidad: document.getElementById('asigMod').value
            };

            const res = await fetch(API_HOR+'/asignar-horario', {method: method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            
            if(res.ok) {
                mostrarToast("‚úÖ Horario guardado correctamente", "bg-success");
                modalAsig.hide();
                cargarTablaHorarios();
            } else {
                const err = await res.json();
                mostrarToast("‚õî " + err.error, "bg-danger");
            }
        }

        async function cargarTablaHorarios() {
            const cid = document.getElementById('filtroCarreraHor').value; const tb = document.getElementById('tabla-horarios-todos'); tb.innerHTML='';
            if(cid==0) { tb.innerHTML='<tr><td colspan="9" class="text-center">Seleccione carrera</td></tr>'; return; }
            const res = await fetch(`${API_HOR}/horarios-todos?carrera=${cid}`); const data = await res.json();
            if(data.length===0) tb.innerHTML='<tr><td colspan="9" class="text-center">No hay horarios</td></tr>';
            
            data.forEach(h => {
                const hString = encodeURIComponent(JSON.stringify(h));
                tb.innerHTML+=`
                <tr>
                    <td>${h.ciclo}</td><td>${h.curso_nombre}</td><td>${h.seccion}</td><td>${h.profesor_nombre}</td>
                    <td>${h.dia}</td><td>${h.hora_inicio.slice(0,5)}-${h.hora_fin.slice(0,5)}</td>
                    <td>${h.vacantes}</td><td>${h.modalidad||'-'}</td>
                    <td>
                        <button onclick="editarHorario('${hString}')" class="btn btn-sm btn-warning" title="Editar"><i class="fa fa-edit"></i></button>
                        <button onclick="eliminarHorario(${h.id})" class="btn btn-sm btn-danger" title="Eliminar"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }
    </script>
</body>
</html>